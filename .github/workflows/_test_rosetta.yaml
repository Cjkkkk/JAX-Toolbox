name: ~test and lint Rosetta

on:
  # Manual trigger
  workflow_dispatch:
  # Called from another workflow
  workflow_call:
    inputs:
      ROSETTA_IMAGE:
        type: string
        description: 'Rosetta image build by NVIDIA/JAX-Toolbox'
        required: true
        default: 'ghcr.io/nvidia/rosetta:latest'

jobs:
  rosetta-tests:
    strategy:
      matrix:
        MARKERS: ["", "-m integration"]
      fail-fast: false
    runs-on: [self-hosted, compute, V100]
    steps:
      - name: Print environment variables
        run: |
          env

      - name: Print GPU information
        run: nvidia-smi  

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Rosetta image
        shell: bash -x -e {0}
        run: |
          docker pull ${{ inputs.ROSETTA_IMAGE }}

      - name: Run Rosetta tests w/ docker
        run: |
          set -x
          docker run --gpus '"device=0,1"' ${{ inputs.ROSETTA_IMAGE }} sh -c "pip install '/opt/rosetta[test]' && pytest /opt/rosetta ${{ matrix.MARKERS }}"

  rosetta-lint-check:
    runs-on: ubuntu-22.04
    steps:
      - name: Print environment variables
        run: |
          env

      - name: Check out the repository under ${GITHUB_WORKSPACE}
        uses: actions/checkout@v3

      - name: Run ruff linter on rosetta
        uses: addnab/docker-run-action@v3
        with:
          image: python:3.8.10
          options: -v ${{ github.workspace }}:/opt/rosetta
          run: |
            pip install ruff
            ruff /opt/rosetta

